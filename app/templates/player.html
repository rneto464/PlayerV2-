<!DOCTYPE html>
<html lang="pt" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayerV2 - IA Music Discovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', 'Roboto', sans-serif; }
        .frame { background-color: #181818; border-radius: 0.5rem; padding: 1.5rem; border: 1px solid #282828; }
        .btn { padding: 0.5rem 1rem; border-radius: 9999px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
        .btn-primary { background-color: #1DB954; color: black; }
        .btn-primary:hover { background-color: #1ED760; transform: scale(1.05); }
        .btn-secondary { background-color: #535353; color: white; }
        .btn-secondary:hover { background-color: #737373; }
        .btn-danger { background-color: #d9534f; color: white; }
        .btn-danger:hover { background-color: #c9302c; }
        .list-item:hover, .list-item-playlist:hover { background-color: #282828; }
        .list-item-playlist .playlist-name { cursor: pointer; }
        .feedback-btn { font-size: 1.25rem; transition: transform 0.2s; background: none; border: none; padding: 0.25rem; cursor: pointer; }
        .feedback-btn:hover { transform: scale(1.2); }
        .playlist-input { background-color: #333; border: 1px solid #535353; color: #e0e0e0; border-radius: 0.25rem; padding: 0.5rem; width: 100%;}
        .action-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4">
        
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-6">
                <h1 class="text-3xl font-bold text-white">PlayerV2</h1>
                <a href="/community" class="text-sm text-gray-300 hover:text-white border-b-2 border-transparent hover:border-white transition-colors">Comunidade</a>
            </div>
            <div id="auth-section"></div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 flex flex-col gap-8">
                <div class="frame">
                    <h2 class="text-xl font-bold mb-4 text-center">Recomenda√ß√µes por Ambiente</h2>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-6">
                        <div>
                            <input type="file" id="imageInput" class="sr-only" accept="image/*" aria-label="Selecionar imagem para an√°lise">
                            <button id="uploadButton" class="btn btn-primary">üì∑ Carregar Imagem</button>
                        </div>
                        <div id="imagePreviewContainer" class="w-28 h-28 bg-gray-800 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-600">
                            <span class="text-gray-500">Preview</span>
                        </div>
                    </div>
                    <div id="status" class="text-center mt-4 text-gray-400 italic">Selecione uma imagem para come√ßar...</div>
                </div>
                
                <div class="frame flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 id="recommendationsTitle" class="text-xl font-bold">Recomenda√ß√µes</h2>
                        <div id="playlistGlobalActions" class="flex items-center gap-2 hidden">
                            <button id="likePlaylistButton" class="feedback-btn" title="Gostei desta playlist">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/></svg>
                            </button>
                            <button id="dislikePlaylistButton" class="feedback-btn" title="N√£o gostei desta playlist">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-1.113 2.175-.246 5.258 1.95 7.452l.748.818.748.818L8 15.01l.255-.286.748-.818.748-.818c2.196-2.194 3.063-5.277 1.95-7.452C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-2.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-2.042 23.333 4.867 8 15z"/></svg>
                            </button>
                            <button id="refreshButton" class="btn btn-secondary text-xs">üîÑ Refazer</button>
                        </div>
                    </div>
                    <div id="playlistCreationActions" class="mb-4 hidden">
                        <label for="playlistNameInput" class="block text-sm font-bold mb-2" >Nome da Playlist:</label>
                        <div class="flex gap-4">
                            <input type="text" spellcheck="false" id="playlistNameInput" class="playlist-input flex-grow">
                            <button id="createPlaylistButton" class="btn btn-primary text-xs hidden">üíæ Criar</button>
                        </div>
                    </div>
                    <div id="recommendationsList" class="flex-grow max-h-96 overflow-y-auto">
                        <p class="text-gray-500">As recomenda√ß√µes aparecer√£o aqui.</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 frame flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Suas Playlists Locais</h2>
                    <button id="saveLocalPlaylistButton" class="btn btn-secondary text-xs hidden" title="Guardar as recomenda√ß√µes atuais como uma nova playlist local">üíæ Guardar Atual</button>
                </div>
                <div id="savedPlaylistsContainer" class="flex-grow max-h-[30rem] overflow-y-auto">
                    <p id="savedPlaylistsPlaceholder" class="text-gray-500">Fa√ßa login para ver as suas playlists.</p>
                    <div id="savedPlaylistsList" class="space-y-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const authSection = document.getElementById('auth-section');
            const uploadButton = document.getElementById('uploadButton');
            const imageInput = document.getElementById('imageInput');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const statusDiv = document.getElementById('status');
            const recommendationsList = document.getElementById('recommendationsList');
            const recommendationsTitle = document.getElementById('recommendationsTitle');
            const playlistGlobalActions = document.getElementById('playlistGlobalActions');
            const createPlaylistButton = document.getElementById('createPlaylistButton');
            const refreshButton = document.getElementById('refreshButton');
            const playlistCreationActions = document.getElementById('playlistCreationActions');
            const playlistNameInput = document.getElementById('playlistNameInput');
            const savedPlaylistsList = document.getElementById('savedPlaylistsList');
            const savedPlaylistsPlaceholder = document.getElementById('savedPlaylistsPlaceholder');
            const saveLocalPlaylistButton = document.getElementById('saveLocalPlaylistButton');

            let currentRecommendations = [];
            let currentTags = [];
            let currentUser = null;

            async function checkLoginStatus() {
                try {
                    const response = await fetch('/api/user_status');
                    const data = await response.json();
                    currentUser = data.logged_in ? data : null;
                    if (data.logged_in) {
                        const serviceName = data.service ? data.service.charAt(0).toUpperCase() + data.service.slice(1) : "Desconhecido";
                        authSection.innerHTML = `<div class="flex items-center gap-4"><span class="text-sm">Logado como: <strong class="text-green-400">${data.display_name}</strong> via ${serviceName}</span><a href="/logout" class="btn btn-secondary text-xs">Logout</a></div>`;
                        
                        if (data.service === 'spotify') {
                            createPlaylistButton.textContent = 'üíæ Criar no Spotify';
                        } else if (data.service === 'youtube') {
                            createPlaylistButton.textContent = 'üíæ Criar no YouTube';
                        }
                        
                        loadSavedPlaylists();
                    }
                } catch (error) { console.error('Erro de login status:', error); }
            }

            async function loadSavedPlaylists() {
                savedPlaylistsList.innerHTML = '';
                savedPlaylistsPlaceholder.textContent = 'A carregar...';
                // --- TODA ESTA L√ìGICA FOI ADICIONADA ---
                if (!currentUser || currentUser.service !== 'spotify') {
                    savedPlaylistsPlaceholder.textContent = 'Suas guarde playlists locaimente.';
                    return;
                }
                try {
                    const response = await fetch('/api/local_playlists');
                    const playlists = await response.json();
                    
                    if (response.ok && playlists.length > 0) {
                        savedPlaylistsPlaceholder.classList.add('hidden');
                        playlists.forEach(playlist => {
                            const playlistItem = document.createElement('div');
                            playlistItem.className = 'list-item-playlist flex justify-between items-center p-2 rounded';
                            playlistItem.innerHTML = `
                                <span class="flex-grow cursor-pointer view-playlist-btn" data-playlist-id="${playlist.id}" data-playlist-name="${playlist.name}">${playlist.name}</span>
                                <div class="flex-shrink-0 flex gap-2">
                                    <button class="rename-btn btn-secondary action-btn" data-playlist-id="${playlist.id}" data-playlist-name="${playlist.name}" title="Renomear">‚úèÔ∏è</button>
                                    <button class="delete-btn btn-danger action-btn" data-playlist-id="${playlist.id}" data-playlist-name="${playlist.name}" title="Apagar">üóëÔ∏è</button>
                                </div>`;
                            savedPlaylistsList.appendChild(playlistItem);
                        });
                    } else {
                        savedPlaylistsPlaceholder.textContent = 'Nenhuma playlist salva.';
                        savedPlaylistsPlaceholder.classList.remove('hidden');
                    }
                } catch (error) { 
                    console.error("Erro ao carregar playlists:", error);
                    savedPlaylistsPlaceholder.textContent = 'Erro ao carregar playlists.';
                }
            }
            
            uploadButton.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => imagePreviewContainer.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover rounded-lg">`;
                    reader.readAsDataURL(file);
                    uploadAndRecommend(file);
                }
            });

            async function uploadAndRecommend(file) {
                statusDiv.textContent = 'A analisar imagem e ambiente...';
                playlistGlobalActions.classList.add('hidden');
                playlistCreationActions.classList.add('hidden');
                recommendationsList.innerHTML = '<p class="text-gray-500">A processar...</p>';
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const response = await fetch('/api/recommend_by_image', { method: 'POST', body: formData });
                    if (!response.ok) { 
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Erro do Servidor: ${response.status}`); 
                    }
                    const data = await response.json();
                    statusDiv.textContent = 'An√°lise conclu√≠da. A gerar recomenda√ß√µes...';
                    displayRecommendations(data, true);
                } catch (error) { console.error('Erro:', error); statusDiv.textContent = `Erro: ${error.message}`; }
            }

             function displayRecommendations(data, isFeedbackEnabled = true) {
                    currentTags = data.ambiente_detetado || [];
                    currentRecommendations = data.recomendacoes || [];
                    recommendationsTitle.textContent = data.playlist_title || `Recomenda√ß√µes`;
                    
                    playlistGlobalActions.classList.toggle('hidden', !isFeedbackEnabled || currentRecommendations.length === 0);
                    playlistCreationActions.classList.toggle('hidden', !currentUser || currentRecommendations.length === 0);
                    
                    // --- CORRE√á√ÉO AQUI: O bot√£o agora aparece para qualquer utilizador logado ---
                    saveLocalPlaylistButton.classList.toggle('hidden', !currentUser || currentRecommendations.length === 0);

                    if (currentRecommendations.length > 0) {
                        if (currentUser) {
                            playlistNameInput.value = data.playlist_title || '';
                            createPlaylistButton.classList.remove('hidden');
                        }
            
            recommendationsList.innerHTML = '';
            currentRecommendations.forEach(track => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item flex justify-between items-center p-2';
                const trackInfo = document.createElement('div');
                trackInfo.innerHTML = `<p class="font-bold truncate">${track.titulo || 'N/A'}</p><p class="text-sm text-gray-400 truncate">${track.artista || 'N/A'}</p>`;
                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-4';
                
                const platformId = track.spotify_id || track.id;
                const service = track.service_name || track.service || (currentUser ? currentUser.service : 'spotify');
                const previewLink = service === 'youtube'
                    ? `https://www.youtube.com/watch?v=${platformId}`
                    : `https://open.spotify.com/track/${platformId}`;

                const feedbackButtonsHTML = isFeedbackEnabled && currentUser.service === 'spotify' ? `
                    <button class="feedback-btn like-track-btn" title="Gosto" data-rating="1" data-track='${JSON.stringify(track)}'>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/></svg>
                    </button>
                    <button class="feedback-btn dislike-track-btn" title="N√£o Gosto" data-rating="-1" data-track='${JSON.stringify(track)}'>
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-1.113 2.175-.246 5.258 1.95 7.452l.748.818.748.818L8 15.01l.255-.286.748-.818.748-.818c2.196-2.194 3.063-5.277 1.95-7.452C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-2.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-2.042 23.333 4.867 8 15z"/></svg>
                    </button>
                ` : '';

                actions.innerHTML = `
                    ${feedbackButtonsHTML}
                    <a href="${previewLink}" target="_blank" title="Abrir na plataforma" class="text-2xl hover:text-green-400 transition-colors">‚ñ∂Ô∏è</a>
                `;
                listItem.appendChild(trackInfo);
                listItem.appendChild(actions);
                recommendationsList.appendChild(listItem);
            });
        } else {
            recommendationsList.innerHTML = '<p class="text-gray-500">Nenhuma m√∫sica encontrada para este ambiente.</p>';
        }
    }

            async function handleApiAction(url, options) {
                statusDiv.textContent = 'A processar o seu pedido...';
                try {
                    const response = await fetch(url, options);
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `Erro ${response.status}`);
                    alert(result.message || 'Opera√ß√£o bem-sucedida!');
                    statusDiv.textContent = 'Pedido conclu√≠do.';
                    return result;
                } catch (error) {
                    console.error('Erro na a√ß√£o da API:', error);
                    alert(`Erro: ${error.message}`);
                    statusDiv.textContent = `Erro: ${error.message}`;
                    return null;
                }
            }

            createPlaylistButton.addEventListener('click', () => {
                if (!currentUser) return;
                const playlistName = playlistNameInput.value.trim() || recommendationsTitle.textContent;
                if (!playlistName) { alert("Introduza um nome para a playlist."); return; }
                
                handleApiAction('/api/create_playlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: playlistName, tracks: currentRecommendations })
                }).then(result => {
                    if (result && result.success && currentUser.service === 'spotify') {
                        loadSavedPlaylists();
                    }
                });
            });

            saveLocalPlaylistButton.addEventListener('click', async () => {
                if (!currentUser || currentUser.service !== 'spotify') { alert("Apenas para utilizadores Spotify."); return; }
                const suggestedName = playlistNameInput.value.trim() || recommendationsTitle.textContent;
                const playlistName = prompt("Nome para a nova playlist local:", suggestedName);
                if (!playlistName) return;
                const result = await handleApiAction('/api/local_playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: playlistName, tracks: currentRecommendations })
                });
                if (result && result.success) loadSavedPlaylists();
            });

            refreshButton.addEventListener('click', async () => {
                if (currentTags.length === 0) return;
                statusDiv.textContent = `A refazer recomenda√ß√µes...`;
                recommendationsList.innerHTML = '<p class="text-gray-500">A processar...</p>';
                try {
                    const response = await fetch('/api/recommend_from_tags', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tags: currentTags })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    statusDiv.textContent = 'Recomenda√ß√µes atualizadas!';
                    displayRecommendations(data, true);
                } catch (error) { console.error('Erro ao refazer:', error); statusDiv.textContent = `Erro: ${error.message}`; }
            });
            
            recommendationsList.addEventListener('click', async (event) => {
                const target = event.target;
                if (target.closest('.feedback-btn')) {
                    const button = target.closest('.feedback-btn');
                    if (!currentUser || currentUser.service !== 'spotify') { return; }
                    button.style.transform = 'scale(1.5)';
                    setTimeout(() => { button.style.transform = 'scale(1)'; }, 200);
                    const rating = parseInt(button.dataset.rating, 10);
                    const trackInfo = JSON.parse(button.dataset.track);
                    await handleApiAction('/api/feedback', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ track_info: trackInfo, rating: rating })
                    });
                }
            });
            
            savedPlaylistsList.addEventListener('click', async (event) => {
                const target = event.target;
                const playlistItem = target.closest('.list-item-playlist');
                if (!playlistItem) return;

                const renameButton = playlistItem.querySelector('.rename-btn');
                const deleteButton = playlistItem.querySelector('.delete-btn');
                const viewButton = playlistItem.querySelector('.view-playlist-btn');
                
                const playlistId = renameButton.dataset.playlistId;
                const oldName = renameButton.dataset.playlistName;

                if (target === renameButton) {
                    const newName = prompt(`Digite o novo nome para a playlist "${oldName}":`);
                    if (newName && newName.trim() !== '') {
                        const success = await handleApiAction(`/api/rename_local_playlist/${playlistId}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_name: newName.trim() })
                        });
                        if (success) loadSavedPlaylists();
                    }
                } else if (target === deleteButton) {
                    if (confirm(`Tem a certeza que quer apagar a playlist "${oldName}"?`)) {
                        const success = await handleApiAction(`/api/delete_local_playlist/${playlistId}`, { method: 'DELETE' });
                        if (success) loadSavedPlaylists();
                    }
                } else if (target === viewButton) {
                    statusDiv.textContent = `A carregar m√∫sicas da playlist...`;
                    try {
                        const response = await fetch(`/api/local_playlists/${playlistId}`);
                        const tracks = await response.json();
                        if (!response.ok) throw new Error(tracks.error);
                        displayRecommendations({ 
                            recomendacoes: tracks, 
                            ambiente_detetado: [],
                            playlist_title: `Conte√∫do de: ${oldName}`
                        }, false);
                    } catch (error) { console.error('Erro ao carregar m√∫sicas:', error); }
                }
            });
            async function handlePlaylistFeedback(rating) {
                if (!currentUser || currentUser.service !== 'spotify') { return; }
                if (currentRecommendations.length === 0) return;
                await handleApiAction('/api/playlist_feedback', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracks: currentRecommendations, rating: rating })
                });
            }
            likePlaylistButton.addEventListener('click', () => handlePlaylistFeedback(1));
            dislikePlaylistButton.addEventListener('click', () => handlePlaylistFeedback(-1));

            checkLoginStatus();
        });
    </script>
</body>
</html>
